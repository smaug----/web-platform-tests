<!DOCTYPE html>
<title>DedicatedWorker: import Layered APIs</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>

// Start a dedicated worker for |scriptURL| and wait until MessageEvents from
// imported modules up to |expectedNumberOfImportedModules|.
function RunImportTest(scriptURL, expectedNumberOfImportedModules) {
  return new Promise(resolve => {
    let numberOfImportedModules = 0;
    const worker = new Worker(scriptURL, { type: 'module' });
    worker.onmessage = e => {
      if (e.data === 'LOADED')
        ++numberOfImportedModules;
      if (numberOfImportedModules === expectedNumberOfImportedModules)
        resolve();
    };
  });
}

// promise_test(() => {
//   return RunImportTest('std:blank|' + location.origin + '/workers/modules/resources/static-import-worker.js', 0);
// }, 'Layered API as a worker script');

// promise_test(() => {
//   return RunImportTest('std:blank', 0);
// }, 'Layered API without fallback as a worker script');

// promise_test(() => {
//   return RunImportTest('std:none|' + location.origin + '/workers/modules/resources/static-import-worker.js', 2);
// }, 'Layered API fallback as a worker script');

promise_test(() => {
  return RunImportTest('resources/static-import-worker-layered-api.js', 1);
}, 'Test static import (Layered API) on DedicatedWorkerGlobalScope.');

promise_test(() => {
  return RunImportTest(
      'resources/static-import-worker-layered-api-fallback.sub.js', 2);
}, 'Test static import (Layered API fallback) on DedicatedWorkerGlobalScope.');

promise_test(() => {
  return RunImportTest('resources/dynamic-import-worker-layered-api.js', 1);
}, 'Test dynamic import (Layered API) on DedicatedWorkerGlobalScope.');

promise_test(() => {
  return RunImportTest(
      'resources/dynamic-import-worker-layered-api-fallback.sub.js', 2);
}, 'Test dynamic import (Layered API fallback) on DedicatedWorkerGlobalScope.');

</script>
